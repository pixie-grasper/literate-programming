#!/usr/bin/env ruby

require 'getoptlong'
require 'literate/programming'

def usage
  print <<-EOM
Usage: rweave [command]... source.wrb...

 commands:
  -h, -?, --help, --usage     show this message and exit
  -fFORMAT, --format=FORMAT   specify output format
                              default: Markdown

 formats:
  md    Markdown
  tex   LaTeX
  EOM
  exit
end

def main
  options = {}
  begin
    GetoptLong.new.set_options(
      %w/-h -? --help --usage/ << GetoptLong::NO_ARGUMENT,
      %w/-f --format/ << GetoptLong::REQUIRED_ARGUMENT,
    ).each_option do |name, value|
      options[name.sub(/^--?/, '').gsub(/-/, '_').to_sym] = value
    end
  rescue GetoptLong::Error
    usage
  end

  usage if ARGV.length == 0 or options.member? :h
  ARGV.each do |ifname|
    inst = Literate::Programming.new File.open(ifname, 'r').read
    case options[:f]
    when 'md', nil
      ofname = File.dirname(ifname) + '/' + File.basename(ifname, '.wrb') + '.md'
      File.open(ofname, 'w').write inst.to_md
    when 'tex'
      ofname = File.dirname(ifname) + '/' + File.basename(ifname, '.wrb') + '.tex'
      File.open(ofname, 'w').write inst.to_tex
    else
      raise 'unknown format ' + options[:f]
    end
  end
end

main
